% /=====================================================================\ %
% |  latexmlleeds.sty                                                   | %
% | Style file for Leeds tweaks to latexml documents                    | %
% |=====================================================================| %
% | Vincenzo Mantova <v.l.mantova@leeds.ac.uk>                          | %
% \=====================================================================/ %

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{latexmlleeds}[2020/09/24 Leeds tweaks to latexml documents]

% We need \iflatexml
\RequirePackage{latexml}

% We need T1 font encoding to parse correctly < and >
\RequirePackage[T1]{fontenc}

%%% Output HTML from LaTeX
% Do nothing in normal LaTeX, output argument as HTML in LaTeXML
\let\ldsHTML\@gobble
\let\lxHTML\ldsHTML % DEPRECATED, only here for backward compatibility

% Example:
% \ldsHTML{This appears <strong>only in the HTML-based outputs</strong>.}

%%% NOTES
%
% 1. The HTML must be written in "XML serialisation", hence all tags must
%    be closed (e.g. <br> must be written as <br/>).
%
% 2. The HTML is still interpreted as LaTeX code, hence it must be escaped
%    appropriately. For instance, every { must be replaced by \{; every &
%    must be replaced by \& (and probably be written as \&amp;).

\RequirePackage{xkeyval}

%%% TikZ workaround

\newif\ifLDS@tikzextern
\newif\ifLDS@tikztosvg
\newif\ifLDS@tikzcd

\DeclareOptionX{tikzextern}[images/TikZ-]{
  \LDS@tikzexterntrue
  \def\LDS@tikzextern{#1}
}

\DeclareOptionX{tikz2svg}[pdf2svg]{
  \ifdefined\LDS@tikzextern
  \else
    \LDS@tikzexterntrue
    \def\LDS@tikzextern{\LDS@tikzextern@default}
  \fi
  \LDS@tikztosvgtrue
  \def\LDS@tikztosvg{#1}
}

\def\LDS@tikzscale{1.333}
\DeclareOptionX{tikzscale}{
  \def\LDS@tikzscale{#1}
}

\DeclareOptionX{tikzcd}{
  \ifdefined\LDS@tikzextern
  \else
    \LDS@tikzexterntrue
    \def\LDS@tikzextern{\LDS@tikzextern@default}
  \fi
  \LDS@tikzcdtrue
}

\ProcessOptionsX

\ifLDS@tikzextern
  \iflatexml
    \RequirePackage{graphicx}
    \RequirePackage{environ}
    % environ uses \@checkend, which is not implemented by LaTeXML
    % below is a copy from latex.ltx
    \def\@checkend#1{\def\reserved@a{#1}\ifx
          \reserved@a\@currenvir \else\@badend{#1}\fi}

    % create the picture counter
    \newcounter{LDS@tikzpicturecounter}

    % set up tikzpicture replacement: include the image and
    % increment the counter
    \newcommand{\LDS@includetikzexternalized}{%
      \includegraphics{\LDS@tikzextern\theLDS@tikzpicturecounter}%
      \stepcounter{LDS@tikzpicturecounter}%
    }

    % replace the tikzpicture environment with
    % \latexmlleeds@includetikzexternalized
    \RenewEnviron{tikzpicture}{\LDS@includetikzexternalized}

    % DEPRECATED: included for backward compatibility
    \let\includetikzexternalized\LDS@includetikzexternalized
  \else
    \RequirePackage{tikz}
    \usetikzlibrary{external}

    % ask TikZ to export all figures to external files
    % recall to call pdflatex with the option -shell-escape to make this work
    \tikzexternalize[figure name=\LDS@tikzextern]
  \fi
\fi

\ifLDS@tikztosvg
  \iflatexml
  \else
    % extend the pdflatex call to also convert the output to SVG
    \tikzset{external/system call={%
      % call pdflatex (this is the TikZ default as per documentation)
      pdflatex \tikzexternalcheckshellescape -halt-on-error -interaction=batchmode -jobname "\image" "\texsource"; %
      % convert using pdf2svg
      \LDS@tikztosvg\space "\image.pdf" "\image.svg" ; %
      % convert points to pixels using the formula 1 pixel = 1.333 points
      % for readability, the actual command is:
      % perl -pi.orig -e 's/(width|height)="(\d+\.\d+)pt"/$1."=\"".sprintf("\%.3f",$2*1.33)."pt\""/eg' "\image.svg"
      % apologies for the perl golf
      perl -pi.orig -e 's/(width|height)="(\@backslashchar d+\@backslashchar.\@backslashchar d+)pt"/\string$1."=\@backslashchar"".int(\string$2*\LDS@tikzscale)."px\@backslashchar""/eg' "\image.svg"%
    }}
  \fi
\fi

\ifLDS@tikzcd
  % tikz-cd is not compatible with the external TikZ library
  % this makes tikz-cd compatible with external using a workaround based on
  % https://tex.stackexchange.com/questions/171931/are-the-tikz-libraries-cd-and-external-incompatible-with-one-another
  \RequirePackage{environ}

  % environ uses \@checkend, which is not implemented by LaTeXML
  % below is a copy from latex.ltx
  \def\@checkend#1{\def\reserved@a{#1}\ifx
        \reserved@a\@currenvir \else\@badend{#1}\fi}

  % replace & with an active character
  % Q: will this have side effect?
  \def\LDS@ampersand{&} \catcode`&=\active \let&=\LDS@ampersand

  \iflatexml
    \RenewEnviron{tikzcd}{\LDS@includetikzexternalized}
  \else
    \RequirePackage{etoolbox}

    % save tikzcd original environment
    \let\LDS@tikzcd\tikzcd
    \let\LDS@endtikzcd\endtikzcd

    % wrap tikzcd into tikzpicture
    \newcommand{\LDS@tikzcd@wrap}[2]{%
      \begin{tikzpicture}[baseline=(ldsTikZcdnode.base)]%
        \node (ldsTikZcdnode) [inner sep=0, outer sep=0] {\LDS@tikzcd[#2]%
            #1 %
        \LDS@endtikzcd};%
      \end{tikzpicture}}
    \RenewEnviron{tikzcd}[1][]{%
      \def\LDS@tikzcd@args{#1}%
      \edef\LDS@tikzcd@cmd{\noexpand\LDS@tikzcd@wrap{\expandonce\BODY}{\expandonce\LDS@tikzcd@args}}%
      \LDS@tikzcd@cmd%
    }
  \fi
\fi
