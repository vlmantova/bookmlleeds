\documentclass[a4paper]{article}

\usepackage[nocomments]{latexml}
\usepackage{latexmlleeds}

\usepackage[pdfusetitle,colorlinks]{hyperref}
\usepackage[dvipsnames]{xcolor}

\usepackage{cmbright}

\setlength{\parindent}{0pt}
\setlength{\parskip}{0.3em}

\usepackage{listings}
\lstset{basicstyle=\small\ttfamily,
  keywordstyle=\color{blue}\bfseries,
  ndkeywordstyle=\color{ForestGreen}\bfseries,
  stringstyle=\color{red},
  commentstyle=\color{ForestGreen}
}

\lstdefinelanguage{CSS}{sensitive,
  keywords={accelerator,azimuth,background,background-attachment,background-color,background-image,background-position,background-position-x,background-position-y,background-repeat,behavior,border,border-bottom,border-bottom-color,border-bottom-style,border-bottom-width,border-collapse,border-color,border-left,border-left-color,border-left-style,border-left-width,border-right,border-right-color,border-right-style,border-right-width,border-spacing,border-style,border-top,border-top-color,border-top-style,border-top-width,border-width,bottom,caption-side,clear,clip,color,content,counter-increment,counter-reset,cue,cue-after,cue-before,cursor,direction,display,elevation,empty-cells,filter,float,font,font-family,font-size,font-size-adjust,font-stretch,font-style,font-variant,font-weight,height,ime-mode,include-source,layer-background-color,layer-background-image,layout-flow,layout-grid,layout-grid-char,layout-grid-char-spacing,layout-grid-line,layout-grid-mode,layout-grid-type,left,letter-spacing,line-break,line-height,list-style,list-style-image,list-style-position,list-style-type,margin,margin-bottom,margin-left,margin-right,margin-top,marker-offset,marks,max-height,max-width,min-height,min-width,-moz-binding,-moz-border-radius,-moz-border-radius-topleft,-moz-border-radius-topright,-moz-border-radius-bottomright,-moz-border-radius-bottomleft,-moz-border-top-colors,-moz-border-right-colors,-moz-border-bottom-colors,-moz-border-left-colors,-moz-opacity,-moz-outline,-moz-outline-color,-moz-outline-style,-moz-outline-width,-moz-user-focus,-moz-user-input,-moz-user-modify,-moz-user-select,orphans,outline,outline-color,outline-style,outline-width,overflow,overflow-X,overflow-Y,padding,padding-bottom,padding-left,padding-right,padding-top,page,page-break-after,page-break-before,page-break-inside,pause,pause-after,pause-before,pitch,pitch-range,play-during,position,quotes,-replace,richness,right,ruby-align,ruby-overhang,ruby-position,-set-link-source,size,speak,speak-header,speak-numeral,speak-punctuation,speech-rate,stress,scrollbar-arrow-color,scrollbar-base-color,scrollbar-dark-shadow-color,scrollbar-face-color,scrollbar-highlight-color,scrollbar-shadow-color,scrollbar-3d-light-color,scrollbar-track-color,table-layout,text-align,text-align-last,text-decoration,text-indent,text-justify,text-overflow,text-shadow,text-transform,text-autospace,text-kashida-space,text-underline-position,top,unicode-bidi,-use-link-source,vertical-align,visibility,voice-family,volume,white-space,widows,width,word-break,word-spacing,word-wrap,writing-mode,z-index,zoom},
  morecomment=[s]{/*}{*/},
  alsoletter={-}}

\usepackage{amsthm}
\theoremstyle{definition}
\newtheorem{exa}{Example}[subsection]

\title{LaTeXML Leeds tweaks}
\author{Vincenzo Mantova}
\date{24 August 2020}

\begin{document}

\maketitle

\tableofcontents

\section{Quick guide to \texttt{latexmlleeds}}
\begin{enumerate}
  \item If you can, update your \LaTeXML{} to v0.8.4. Rumour is that v0.8.5 will be released ``this month''. Previous versions (0.8.2, 0.8.3) will generally work, but they support fewer packages, and the output will look a bit worse. This guide is only tested with version 0.8.4.
  \item Copy the files below next to the \verb|.tex| source.
  \begin{itemize}
    \item \verb|latexmlleeds.sty|
    \item \verb|latexmlleeds.sty.ltxml|
    \item \verb|latexmlleeds.css|
    \item \verb|latexmlleeds-html5.xsl|
    \item \verb|latexml.sty| if your \TeX{} installation does not pick it up automatically
  \end{itemize}
  You can download them from the \href{https://dev.azure.com/pmtvlm-leeds-ac-uk/public/_git/latexmlleeds}{\texttt{latexmlleeds} repository}, together with the \verb|.tex| source of this very document. Please submit a pull request if you have changes that should be made available to everyone (e.g.\ improved \CSS{}, other video or quiz embedding commands).
  \item Add
  \begin{lstlisting}[language=TeX]
    \usepackage{latexml} % for \iflatexml and other goodies
    \usepackage{latexmlleeds} % for \lxHTML, see below
  \end{lstlisting}
  to your preamble.
  \item Run the command below and see if there are errors.
  \begin{lstlisting}[language=bash]
    latexml --destination=myfile.xml myfile.tex
  \end{lstlisting}
  If you are lucky, there will be no errors at all. If you get errors, you will have to adjust your \LaTeX{}. You can use \verb|\iflatexml| to run different code under \verb|latexml| -- this is useful if your problems come from packages that are useful only when compiling to PDF.
  \begin{lstlisting}[language=TeX]
    \iflatexml
      % code only executed by latexml
    \else
      % code only executed by the other engines
    \fi
  \end{lstlisting}
  \LaTeXML{} should be able to handle images, but it may choke on TikZ. Read the Vincenzo's \texttt{README} among the \href{https://leeds365.sharepoint.com/sites/TEAM-SchoolofMathematits/Shared%20Documents/Discussion%20-%20Digital%20accessibility/LaTeXML%20Examples}{\LaTeXML{} examples} of the \href{https://teams.microsoft.com/l/channel/19%3aef28f45e3a2e43e88bf416dd94b1c654%40thread.tacv2/Discussion%2520-%2520Digital%2520accessibility?groupId=88aa0346-1c2e-4ac1-bbcc-3d6395bc0a5b&tenantId=bdeaeda8-c81d-45ce-863e-5232a535b7cb}{Digital accessibility channel} for an automated TikZ workaround.
  \item If everything is good, you can conclude with
  \begin{lstlisting}[language=bash]
    % to create the final HTML
    latexmlpost \
      --javascript="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"\
      --mathtex --stylesheet=latexmlleeds-html5.xsl \
      --css=latexmlleeds.css --destination=myfile.html \
      --svg myfile.xml

    % to create the EPUB
    latexmlc --splitat=chapter --css=latexmlleeds.css \
      --svg --destination=myfile.epub myfile.tex
  \end{lstlisting}
  The option \verb|--splitat=| can split the output in various ways (part, chapter, section\dots{}) according to your needs. You \textbf{must} split long lecture notes, otherwise MathJax will take ages to render your formulas and EPUB readers will spend a long time paginating the content.
  \item If you wish to embed Stream videos into your notes, and for more advanced functionality, see \autoref{exa:embed-stream} below. The short story is that you may use the command \verb|\lxHTML{html}| to write arbitrary \HTML{} in your \LaTeX{} file, and that you may write in \verb|latexmlleeds.css| to tweak the style of your document. Armed with the two, you can create any custom command you like -- for instance, embed Forms quizzes, embed Mediasite videos, YouTube videos, and so on.
\end{enumerate}

\section{How to compile this example}
The commands below will use MathJax v3.0.
\begin{lstlisting}[language=bash,caption={Generate the PDF}]
  % I use latexmk, but pdflatex or your preferred engine will work
  latexmk -pdf LaTeXML-Leeds
\end{lstlisting}
\begin{lstlisting}[language=bash,caption={Generate the EPUB}]
  latexmlc --splitat=chapter --css=latexmlleeds.css \
    --destination=LaTeXML-Leeds.epub LaTeXML-Leeds.tex
\end{lstlisting}
\begin{lstlisting}[language=bash,caption={Generate the HTML}]
  latexmlc \
    --javascript="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" \
    --mathtex --stylesheet=latexmlleeds-html5.xsl \
    --css=latexmlleeds.css --destination=LaTeXML-Leeds.html \
    --svg LaTeXML-Leeds.tex
\end{lstlisting}
\begin{lstlisting}[language=bash,caption={Generate the HTML in two steps}]
  latexml --destination=LaTeXML-Leeds.xml LaTeXML-Leeds.tex
  latexmlpost \
    --javascript="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"\
    --mathtex --stylesheet=latexmlleeds-html5.xsl \
    --css=latexmlleeds.css --destination=LaTeXML-Leeds.html \
    --svg LaTeXML-Leeds.xml
\end{lstlisting}

\section{Documentation}

\subsection{The \texttt{latexml} package}
\begin{lstlisting}[language=TeX,caption={Import \texttt{latexml} in the preamble}]
  \usepackage[nocomments]{latexml}
\end{lstlisting}

The package \verb|latexml| takes some options that will be passed to the \LaTeXML{} engine, such as \verb|nocomment| (that strips the \verb|%| comments away) or \verb|mathparsespeculate|. Moreover, it offers a variety of commands. The most important one:
\begin{lstlisting}[language=TeX]
  \iflatexml
    % code only executed by latexml
  \else
    % code only executed by the other engines
  \fi
\end{lstlisting}

\begin{exa}
  Code:
  \begin{lstlisting}[language=TeX]
    \usepackage{latexml}
    ...
    \begin{document}
    ...
    \iflatexml Great, you used \LaTeXML{} successfully!
    \else This is a boring PDF.\fi
  \end{lstlisting}
  Output:
  \begin{quote}
    \iflatexml Great, you used \LaTeXML{} successfully!
    \else This is a boring PDF.\fi
  \end{quote}
\end{exa}

For reference, \verb|latexml| also defines the following, although you can work very well without them. Just open \verb|latexml.sty| (it is very short) to see all the commands, a bit of documentation in the comments, and the occasional example. The \href{https://github.com/brucemiller/LaTeXML/tree/master/doc/manual}{source} of the \LaTeXML{} documentation is also a source of examples.
\begin{itemize}
  \item \verb|\lxAddClass{class}| and \verb|\lxWithClass{class}{content}| to add CSS classes to the output;
  \item \verb|\lxBeginTableHead|, \verb|\lxEndTableHead| and variations to mark table headers and footers (read the \verb|latexml.sty| source for how to use them);
  \item \verb|\lxFcn{code}|, \verb|\lxID{code}|, \verb|\lxPunct{code}| to help \LaTeXML{} understand the meaning of mathematical symbols (\LaTeXML{} recognises the meaning on its own, but every once in a while, there will be a symbol that is just too ambiguous -- just keep an eye on the warnings during compilation);
  \item \verb|\lxContextTOC|, \verb|\lxNavbar{arg}|, \verb|\lxHeader{arg}|, \verb|\lxFooter{arg}| to customise the HTML pages (I have yet to figure out how they work);
  \item and a few other commands.
\end{itemize}

\subsection{The \texttt{latexmlleeds} package}
\begin{lstlisting}[language=TeX,caption={Import \texttt{latexmlleeds} in the preamble}]
  \usepackage{latexmlleeds}
\end{lstlisting}

\verb|latexmlleeds| defines \verb|\lxHTML{html}|, which outputs the \verb|html| argument directly as \HTML{} code. The \verb|html| is only processed by \LaTeXML{} and ignored by the other engines. The \LaTeXML{} processing is done by \verb|latexmlleeds.sty.lxtml|, which is a short Perl file you do not need to touch.
\begin{exa}
  Code:
  \begin{lstlisting}[language=TeX]
    This sentence appears in all versions.
    \lxHTML{<span>But this part is
      <strong>only in the HTML outputs</strong>.</span>}
  \end{lstlisting}
  Output:
  \begin{quote}
    This sentence appears in all versions.
    \lxHTML{<span>But this part is
    <strong>only in the HTML outputs</strong>.</span>}
  \end{quote}
\end{exa}

Some notes:
\begin{itemize}
  \item The \HTML{} must be written in ``\XML{} serialisation'', hence all tags must be closed (e.g.\ \verb|<br>| must be written as \verb|<br/>|) and all attributes must have a value (e.g.\ \verb|allowfullscreen| must be written \verb|allowfullscreen=""|).
  \item The content must be written inside \HTML{} elements. Any text not contained in an element will be dropped. If in doubt, put \verb|<span>...</span>| around your \HTML{}.
  \item The \HTML{} is still interpreted as \LaTeX{} code, hence it must be escaped appropriately. For instance, every \verb|{| must be replaced by \verb|\{|; every \verb|&| must be replaced by \verb|\&| (and probably be written as \verb|\&amp;| -- you must write correct \HTML{}!).
\end{itemize}

\begin{exa}[Embed Stream videos]\label{exa:embed-stream}
  This is only a proof of concept, but already functional: it embeds a video directly into \HTML{} and EPUB, and provides a link in all contexts (note that embedded videos may not work everywhere, especially with EPUB, so always include the link). The code is accompanied by some extra \CSS{} inside \verb|latexmlleeds.css| to make the video size responsive, however you must customize it to match the resolution of your videos (mine is $1280 \times 720$).
  \begin{lstlisting}[language=TeX]
    % preamble
    \newcommand{\includestream}[2]{
    \lxHTML{<div class="ltx\_leeds\_video">
        <iframe 
          src="https://web.microsoftstream.com/embed/video/#1?autoplay=false\&amp;showinfo=true"
          allowfullscreen="">
        </iframe>
      </div>}
      Watch \href{https://web.microsoftstream.com/video/#1}{#2}
    }
    % document
    \includestream{ba6b8866-df29-4dea-a47e-13decc5cd409}
    {Mock recording for Models and Sets}
  \end{lstlisting}

  Output:
  \begin{quote}
    \newcommand{\includestream}[2]{
      \lxHTML{<div class="ltx\_leeds\_video">
          <iframe 
            src="https://web.microsoftstream.com/embed/video/#1?autoplay=false\&amp;showinfo=true"
            allowfullscreen="">
          </iframe>
        </div>}
      Watch \href{https://web.microsoftstream.com/video/#1}{#2}
    }
    \includestream{ba6b8866-df29-4dea-a47e-13decc5cd409}
    {Mock recording for Models and Sets}
  \end{quote}
\end{exa}

\subsection{The \texttt{latexmlleeds-html5.xsl} customisations}
Normally, you do not need to care about this file. The \verb|latexmlleeds.xsl| \XSLT{} stylesheet does only three things:
\begin{itemize}
  \item make sure you output HTML5 (which would be the default, anyway);
  \item it makes \HTML{} lists more accessible by ignoring custom enumerations (i.e., the \verb|(a)| in \verb|\item[(a)]|; you should modify your \CSS{} to do custom enumerations in \HTML{});
  \item it adds modern HTML5 tags to make the output more mobile friendly, and removes the outdated \verb|Content-type| meta tag.
\end{itemize}
The \XSLT{} may be updated in the future to improve a few aspects of the resulting \HTML{}; for instance, we might discover that offloading the maths parsing entirely to MathJax is better overall, and this can only be done by tweaking the \XSLT{}.

\subsection{The \texttt{latexmlleeds.css} customisations}
This is where you can tweak the appearance of your \HTML{} files. For now, the basic \verb|latexmlleeds.css|
\begin{itemize}
  \item sets the font to sans serif (trying to pick the best font available);
  \item reduces the margins to a minimum;
  \item sets the maximum text width to about 80 characters;
  \item reduces the margins on the lists;
  \item removes indentation;
  \item implements responsive styling for embedded videos (see \autoref{exa:embed-stream}).
\end{itemize}
This styling has only been tested with the \verb|article| class and on Edge and Chrome, so further tweaks may be needed.

\section{Good practices}
\begin{itemize}
  \item Follow Martin's recommendations about fonts, tables, margins, and so on.
  \item Use semantic \LaTeX{} commands as much as possible (\verb|\chapter|, \verb|\section|, \verb|\newtheorem|).
  \item Although not strictly needed, it is better to restrict yourself to MathJax supported commands in math mode. In this way the students will be able to copy and paste your \TeX{} code from the lecture notes to the discussion boards, once they learn how to do so. See the MathJax documentation for the full list.
\end{itemize}

\section{Other documentation}
\begin{itemize}
  \item \href{https://dlmf.nist.gov/LaTeXML/docs.html}{\LaTeXML{} documentation}
  \item List of packages \href{https://dlmf.nist.gov/LaTeXML/manual/included.bindings/}{supported by \LaTeXML{}} (note that some implementations are not complete)
  \item \href{http://docs.mathjax.org/en/v2.7-latest/}{MathJax v2.7} documentation
  \item List of \LaTeX{} commands \href{http://docs.mathjax.org/en/v2.7-latest/tex.html#supported-latex-commands}{supported by MathJax v2.7}
  \item \href{http://docs.mathjax.org/en/v3.0-latest/}{MathJax v3.0} documentation
  \item List of \LaTeX{} commands \href{http://docs.mathjax.org/en/v3.0-latest/input/tex/macros/index.html}{supported by MathJax v3.0}
\end{itemize}

\end{document}